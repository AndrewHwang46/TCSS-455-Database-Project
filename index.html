<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Happy Grocery</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 25px;
    }
    .query-info {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    form {
      margin-bottom: 15px;
    }
    label {
      margin-right: 10px;
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    select, button {
      padding: 10px 15px;
      margin: 5px 0;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    select {
      width: 100%;
      max-width: 500px;
      background-color: white;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    textarea {
      width: 100%;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
      font-family: Consolas, monospace;
      font-size: 14px;
      line-height: 1.5;
    }
    pre {
      background-color: #f5f5f5;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: auto;
      max-height: 200px;
      font-family: Consolas, monospace;
      font-size: 14px;
      line-height: 1.5;
    }
    .status-message {
      padding: 12px;
      margin: 15px 0;
      border-radius: 4px;
      font-weight: 500;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    .connection-info {
      margin-top: 20px;
      text-align: center;
      color: #555;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
    .connection-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-weight: bold;
      margin-left: 5px;
    }
    .connected {
      background-color: #d4edda;
      color: #155724;
    }
    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    .checking {
      background-color: #fff3cd;
      color: #856404;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-top-color: #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 5px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .retry-button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
    .retry-button:hover {
      background-color: #2980b9;
    }
    .controls-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    @media (max-width: 768px) {
      .controls-container {
        flex-direction: column;
        align-items: stretch;
      }
      .controls-container select,
      .controls-container button {
        width: 100%;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
<h1>Happy Grocery Query System</h1>

<div class="query-info">
  <p>This interface allows you to execute predefined queries against the grocery store database. Select a query from the dropdown and click "Execute Query" to see the results.</p>
</div>

<div class="controls-container">
  <select name="querySelect" id="querySelect">
    <option value="">Loading queries...</option>
  </select>
  <button id="submitButton" disabled>Execute Query</button>
</div>

<div id="queryDescription" class="query-info">
  <pre id="queryCode">SELECT a query to see the SQL code</pre>
</div>

<div id="statusMessage" class="status-message" style="display: none;"></div>

<textarea id="resultsArea" name="resultsArea" rows="12" cols="80" readonly>Select a query and click 'Execute Query' to see results.</textarea>

<div id="connectionInfo" class="connection-info">
  <p>
    Server Connection Status:
    <span id="connectionStatus" class="connection-status checking">Checking...</span>
    <button id="retryConnectionButton" class="retry-button">Retry Connection</button>
  </p>
  <p id="connectionDetails">Attempting to connect to server...</p>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const submitButton = document.getElementById('submitButton');
    const resultsArea = document.getElementById('resultsArea');
    const querySelect = document.getElementById('querySelect');
    const queryCode = document.getElementById('queryCode');
    const statusMessage = document.getElementById('statusMessage');
    const connectionStatus = document.getElementById('connectionStatus');
    const connectionDetails = document.getElementById('connectionDetails');
    const retryConnectionButton = document.getElementById('retryConnectionButton');

    // Base URL for API
    let baseApiUrl = null;

    // Function to show status messages
    function showStatusMessage(message, type) {
      if (statusMessage) {
        statusMessage.textContent = message;
        statusMessage.className = `status-message ${type}`;
        statusMessage.style.display = 'block';
      } else {
        console.log(`Status: ${message} (${type})`);
      }
    }

    // Function to hide status message
    function hideStatusMessage() {
      if (statusMessage) {
        statusMessage.style.display = 'none';
      }
    }

    // Format results as a table
    function formatResultsAsTable(data) {
      if (!Array.isArray(data) || data.length === 0) {
        return "No data returned from query";
      }

      // Get column names from the first object
      const columns = Object.keys(data[0]);

      // Create header row
      let table = columns.join('\t') + '\n';
      table += '-'.repeat(columns.join('\t').length) + '\n';

      // Add data rows
      data.forEach(row => {
        const rowValues = columns.map(col => {
          const value = row[col];
          if (value === null) return 'NULL';
          if (typeof value === 'number') return value.toString();
          return value;
        });
        table += rowValues.join('\t') + '\n';
      });

      return table;
    }

    // Enhanced connection testing with retry
    async function testServerConnection() {
      const serverUrls = [
        'http://localhost:3001',
        'http://127.0.0.1:3001'
      ];

      connectionStatus.textContent = 'Checking...';
      connectionStatus.className = 'connection-status checking';
      connectionDetails.textContent = 'Attempting connections...';

      for (const url of serverUrls) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000);

          const response = await fetch(`${url}/test`, {
            method: 'GET',
            signal: controller.signal
          });

          clearTimeout(timeoutId);

          if (response.ok) {
            const data = await response.json();
            const dbStatus = data.databaseStatus ? 'Connected' : 'Not Connected';

            connectionStatus.textContent = data.databaseStatus ? 'ðŸŸ¢ Connected' : 'ðŸ”´ DB Disconnected';
            connectionStatus.className = data.databaseStatus ? 'connection-status connected' : 'connection-status disconnected';
            connectionDetails.textContent = `Connected to server at ${url} | Database: ${dbStatus}`;

            baseApiUrl = url;
            return url;
          }
        } catch (error) {
          console.warn(`Connection failed to ${url}:`, error);
        }
      }

      connectionStatus.textContent = 'ðŸ”´ Not Connected';
      connectionStatus.className = 'connection-status disconnected';
      connectionDetails.textContent = 'Could not connect to server. Please check if the server is running.';
      return null;
    }

    // Load available queries
    async function loadQueryInfo(baseUrl) {
      if (!baseUrl) {
        showStatusMessage('Server not reachable. Please check if the server is running.', 'error');
        return;
      }

      try {
        showStatusMessage('Loading queries...', 'info');

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        try {
          const response = await fetch(`${baseUrl}/query-info`, {
            method: 'GET',
            signal: controller.signal,
            headers: {
              'Content-Type': 'application/json'
            }
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
          }

          const data = await response.json();

          if (!data.queries || Object.keys(data.queries).length === 0) {
            throw new Error('No queries found in the response');
          }

          hideStatusMessage();
          querySelect.innerHTML = '';

          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Select a query...';
          querySelect.appendChild(defaultOption);

          Object.entries(data.queries).forEach(([key, query]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = query.title;
            querySelect.appendChild(option);
          });

          submitButton.disabled = false;
          showStatusMessage('Queries loaded successfully!', 'success');
          setTimeout(hideStatusMessage, 3000);

        } catch (fetchError) {
          clearTimeout(timeoutId);
          console.error('Fetch error details:', fetchError);

          showStatusMessage(`Query Load Error: ${fetchError.message}`, 'error');
          querySelect.innerHTML = '';
          const errorOption = document.createElement('option');
          errorOption.value = '';
          errorOption.textContent = 'Failed to load queries';
          querySelect.appendChild(errorOption);
        }
      } catch (outerError) {
        console.error('Outer error:', outerError);
        showStatusMessage(`Unexpected error: ${outerError.message}`, 'error');
      }
    }

    // When a query is selected from dropdown
    querySelect.addEventListener('change', () => {
      const selectedKey = querySelect.value;
      if (!selectedKey) {
        queryCode.textContent = 'SELECT a query to see the SQL code';
        submitButton.disabled = true;
        return;
      }

      // Get the base URL
      if (!baseApiUrl) {
        showStatusMessage('Server connection issue', 'error');
        return;
      }

      // Enable the execute button
      submitButton.disabled = false;

      // Send AJAX request to get the query info
      fetch(`${baseApiUrl}/query-info`)
              .then(response => response.json())
              .then(data => {
                if (data.queries && data.queries[selectedKey]) {
                  queryCode.textContent = data.queries[selectedKey].query;
                }
              })
              .catch(error => {
                console.error('Error fetching query details:', error);
                showStatusMessage(`Error loading query details: ${error.message}`, 'error');
              });
    });

    // When Execute Query button is clicked
    submitButton.addEventListener('click', async () => {
      const selectedKey = querySelect.value;

      if (!selectedKey) {
        showStatusMessage('Please select a query first!', 'warning');
        return;
      }

      // Get the base URL
      if (!baseApiUrl) {
        showStatusMessage('Server connection issue', 'error');
        return;
      }

      showStatusMessage('Executing query...', 'info');
      resultsArea.value = 'Executing query, please wait...';
      submitButton.disabled = true;

      try {
        const response = await fetch(`${baseApiUrl}/execute-query`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ queryKey: selectedKey })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server returned ${response.status}: ${errorText}`);
        }

        const data = await response.json();

        // Format the results
        if (Array.isArray(data) && data.length > 0) {
          resultsArea.value = formatResultsAsTable(data);
        } else if (Array.isArray(data) && data.length === 0) {
          resultsArea.value = "Query executed successfully, but no data was returned.";
        } else {
          resultsArea.value = JSON.stringify(data, null, 2);
        }

        showStatusMessage('Query executed successfully!', 'success');
        setTimeout(hideStatusMessage, 3000);
      } catch (error) {
        console.error('Error executing query:', error);
        resultsArea.value = `Error: ${error.message}`;
        showStatusMessage(`Query execution failed: ${error.message}`, 'error');
      } finally {
        submitButton.disabled = false;
      }
    });

    // Handle retry connection button
    retryConnectionButton.addEventListener('click', async () => {
      connectionStatus.innerHTML = '<span class="loading"></span>Reconnecting...';
      connectionStatus.className = 'connection-status checking';
      connectionDetails.textContent = 'Attempting to reconnect...';

      const connectedUrl = await testServerConnection();
      if (connectedUrl) {
        await loadQueryInfo(connectedUrl);
      }
    });

    // Initial connection and query load
    async function initialize() {
      const connectedUrl = await testServerConnection();
      if (connectedUrl) {
        await loadQueryInfo(connectedUrl);
      }
    }

    initialize();
  });
</script>
</body>
</html>